(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[553],{8271:function(n,e,t){(window.__NEXT_P=window.__NEXT_P||[]).push(["/engineering/docker-size",function(){return t(5797)}])},7845:function(n,e,t){"use strict";var i=t(5893),a=t(5988),l=(new Date).getFullYear();e.Z={footer:(0,i.jsxs)("small",{style:{display:"block",marginTop:"8rem"},className:"jsx-7c359fde634f3543",children:[(0,i.jsx)("time",{className:"jsx-7c359fde634f3543",children:l})," \xa9 Fossil Engineering Blog.",(0,i.jsx)("a",{href:"/feed.xml",className:"jsx-7c359fde634f3543",children:"RSS"}),(0,i.jsx)(a.default,{id:"7c359fde634f3543",children:"a.jsx-7c359fde634f3543 {float:right}\n@media screen and (max-width:480px) {article.jsx-7c359fde634f3543 {padding-top:2rem;\npadding-bottom:4rem}}"})]})}},5797:function(n,e,t){"use strict";t.r(e);t(7294);var i=t(3905),a=t(8941),l=t.n(a),c=t(3805),r=t(7845);function h(n,e){if(null==n)return{};var t,i,a=function(n,e){if(null==n)return{};var t,i,a={},l=Object.keys(n);for(i=0;i<l.length;i++)t=l[i],e.indexOf(t)>=0||(a[t]=n[t]);return a}(n,e);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(n);for(i=0;i<l.length;i++)t=l[i],e.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(n,t)&&(a[t]=n[t])}return a}var m=function(n){return(0,c.withSSG)(l()({filename:"docker-size.md",route:"/engineering/docker-size",meta:{title:"Gi\u1ea3m k\xedch th\u01b0\u1edbc Docker image cho \u1ee9ng d\u1ee5ng Ruby on Rails",date:"2020/1/4",description:"Vi\u1ec7c gi\u1ea3m dung l\u01b0\u1ee3ng Docker image tu\xe2n theo nguy\xean t\u1eafc c\u01a1 b\u1ea3n nh\u1ea5t ch\xednh l\xe0 lo\u1ea1i b\u1ecf c\xe1c th\xe0nh ph\u1ea7n kh\xf4ng c\u1ea7n thi\u1ebft trong Docker image",tag:"engineering",author:"Loi Nguyen"},pageMap:[{name:"engineering",children:[{name:"docker-size",route:"/engineering/docker-size",frontMatter:{title:"Gi\u1ea3m k\xedch th\u01b0\u1edbc Docker image cho \u1ee9ng d\u1ee5ng Ruby on Rails",date:"2020/1/4",description:"Vi\u1ec7c gi\u1ea3m dung l\u01b0\u1ee3ng Docker image tu\xe2n theo nguy\xean t\u1eafc c\u01a1 b\u1ea3n nh\u1ea5t ch\xednh l\xe0 lo\u1ea1i b\u1ecf c\xe1c th\xe0nh ph\u1ea7n kh\xf4ng c\u1ea7n thi\u1ebft trong Docker image",tag:"engineering",author:"Loi Nguyen"}},{name:"git-hook-auto-prefix",route:"/engineering/git-hook-auto-prefix",frontMatter:{title:"Automatically prefix commit message with Git hook",date:"2019/3/09",description:"In order to find all the commits relating to a specific JIRA issue as well as find the issue relating to a specific commit quickly, my team applies a common pattern for all commit message in our projects: `[ISSUE] MESSAGE`",tag:"engineering",author:"Cat Vu"}},{name:"index",route:"/engineering",frontMatter:{type:"posts",title:"Engineering",date:"2021-11-11T00:00:00.000Z"}}],route:"/engineering"},{name:"index",route:"/",frontMatter:{type:"posts",title:"All",date:"2021-11-11T00:00:00.000Z"}},{name:"life",children:[{name:"1234",route:"/life/1234",frontMatter:{title:"1,234 days \u2014 Day 1 at Fossil",date:"2020/02/27",description:"A thousand-ish more days later, I could definitely testify to the jaded Day 1 philosophy by Amazon CEO Jeff Bezos: Every day here has felt just like Day 1.",tag:"Life at Fossil, Careers",author:"Nga Vu"}},{name:"index",route:"/life",frontMatter:{type:"posts",title:"Life at Fossil",date:"2021-11-11T00:00:00.000Z"}}],route:"/life"},{name:"tags",children:[{name:"[tag]",route:"/tags/[tag]",frontMatter:{type:"tag",title:"Tagged Posts"}}],route:"/tags"}]},r.Z))(n)};function u(n){var e=n.components,t=h(n,["components"]);return(0,i.mdx)(m,Object.assign({components:e},t),(0,i.mdx)("h1",null,"Gi\u1ea3m k\xedch th\u01b0\u1edbc Docker image cho \u1ee9ng d\u1ee5ng Ruby on Rails"),(0,i.mdx)("p",null,(0,i.mdx)("img",{src:"https://miro.medium.com/max/1400/1*ovRuAuqPf4r2xpiWh71rUg.png",alt:"",parentName:"p"})),(0,i.mdx)("p",null,"Vi\u1ec7c gi\u1ea3m dung l\u01b0\u1ee3ng Docker image tu\xe2n theo nguy\xean t\u1eafc c\u01a1 b\u1ea3n nh\u1ea5t ch\xednh l\xe0 lo\u1ea1i b\u1ecf c\xe1c th\xe0nh ph\u1ea7n kh\xf4ng c\u1ea7n thi\u1ebft trong Docker image.\n\u0110i\u1ec1u n\xe0y c\xf3 th\u1ec3 \u0111\u1ea1t \u0111\u01b0\u1ee3c d\u1ef1a v\xe0o c\xe1c th\u1ee7 thu\u1eadt sau:"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},"D\xf9ng image base nh\u1ecf: alpine, slim."),(0,i.mdx)("li",{parentName:"ul"},"Multiple stages build."),(0,i.mdx)("li",{parentName:"ul"},"X\xf3a c\xe1c file ko c\u1ea7n thi\u1ebft"),(0,i.mdx)("li",{parentName:"ul"},"D\xf9ng Dockerignore."),(0,i.mdx)("li",{parentName:"ul"},"Gi\u1ea3m s\u1ed1 l\u01b0\u1ee3ng layer.")),(0,i.mdx)("p",null,"\u0110\u1ec3 \u0111\u1ecdc b\xe0i n\xe0y c\xe1c b\u1ea1n c\u1ea7n?"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},"Bi\u1ebft Docker l\xe0 g\xec v\xe0 d\xf9ng \u0111\u1ec3 l\xe0m g\xec."),(0,i.mdx)("li",{parentName:"ul"},"Bi\u1ebft v\xe0 \u0111\xe3 t\u1eebng vi\u1ebft Dockerfile, build Docker images."),(0,i.mdx)("li",{parentName:"ul"},"Bi\u1ebft v\xe0 t\u1eebng l\xe0m vi\u1ec7c v\u1edbi Ruby on Rails.")),(0,i.mdx)("h2",null,"V\u1ea5n \u0111\u1ec1 c\u1ee7a Docker images qu\xe1 n\u1eb7ng"),(0,i.mdx)("h3",null,"C\xe2u chuy\u1ec7n c\u1ee7a m\xecnh"),(0,i.mdx)("p",null,"Th\u1eddi gian tr\u01b0\u1edbc, m\xecnh c\xf3 nh\u1eadn m\u1ed9t project, server \u0111\u1eb7t \u1edf Trung Qu\u1ed1c. M\u1ea1ng m\u1ebdo M\u1eabu Qu\u1ed1c nh\u01b0 m\u1ecdi ng\u01b0\u1eddi \u0111\u1ec1u bi\u1ebft, r\u1ea5t ch\u1eadm khi \u0111i qua \u0111\u01b0\u1eddng truy\u1ec1n qu\u1ed1c t\u1ebf, \u0111\u1ebfn c\u1ea3 Google, Facebook \u0111\u1ec1u h\u1ea7u nh\u01b0 kh\xf4ng s\u1eed d\u1ee5ng \u0111\u01b0\u1ee3c. Code v\xe0 CI server (CI server l\xe0 server \u0111\u1ec3 th\u1ef1c hi\u1ec7n qu\xe1 tr\xecnh build Docker image t\u1eeb code) th\xec \u0111\u1eb7t \u1edf M\u1ef9 (v\xec \u0111\u01a1n gi\u1ea3n b\u1ecdn m\xecnh d\xf9ng Cloud provider, Git remote server \u1edf \u0111\u1ea5y). Push m\u1ed9t Docker image 400 MB qua Trung Qu\u1ed1c trung b\xecnh m\u1ea5t h\u1ebft 40 ph\xfat. Th\u1ec9nh tho\u1ea3ng th\xec h\u01a1n 1 gi\u1edd. C\xf3 khi \u0111ang push gi\u1eefa ch\u1eebng th\xec b\u1ecb disconnect lu\xf4n."),(0,i.mdx)("p",null,"Docker image qu\xe1 l\u1edbn s\u1ebd:"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},"T\u1ed1n th\u1eddi gian upload."),(0,i.mdx)("li",{parentName:"ul"},"T\u1ed1n b\u0103ng th\xf4ng m\u1ea1ng. C\xe1i n\xe0y nguy hi\u1ec3m n\u1ebfu b\u1ea1n s\u1eed d\u1ee5ng \u0111\u01b0\u1eddng m\u1ea1ng ri\xeang, tr\u1ea3 ti\u1ec1n theo l\u01b0u l\u01b0\u1ee3ng."),(0,i.mdx)("li",{parentName:"ul"},"T\u1ed1n ti\u1ec1n l\u01b0u tr\u1eef image tr\xean repository."),(0,i.mdx)("li",{parentName:"ul"},"\u1ee8ng d\u1ee5ng tr\u1edf n\xean c\u1ed3ng k\u1ec1nh, th\u1eddi gian pull image s\u1ebd l\xe2u.")),(0,i.mdx)("p",null,"N\xf3i chung l\xe0 v\u1eeba t\u1ed1n ti\u1ec1n v\u1eeba \u1ea3nh h\u01b0\u1edfng t\u1edbi t\u1ed1c \u0111\u1ed9 release s\u1ea3n ph\u1ea9m. C\xe1c b\u1ea1n th\u1eed ngh\u0129 xem, n\u1ebfu c\xe1c b\u1ea1n ch\u1ec9 mu\u1ed1n \u0111\u1ed5i ch\u1ed7 1 button tr\xean qua ph\u1ea3i 1 pixel, m\xe0 b\u1ea1n ph\u1ea3i \u0111\u1ee3i 1 gi\u1edd \u0111\u1ec3 \u0111\u01b0a cho kh\xe1ch h\xe0ng xem. :) M\xe0 l\xe0m ph\u1ea7n m\u1ec1m th\xec requirement thay \u0111\u1ed5i li\xean t\u1ee5c. N\xean m\xecnh quy\u1ebft \u0111\u1ecbnh t\xecm c\xe1ch gi\u1ea3m dung l\u01b0\u1ee3ng Docker image xu\u1ed1ng."),(0,i.mdx)("p",null,"\u0110\xe2y l\xe0 b\xe0i vi\u1ebft h\u01b0\u1edbng d\u1eabn k\u1ef9 thu\u1eadt \u0111\u1ea7u ti\xean c\u1ee7a m\xecnh, c\u0169ng ch\u1ec9 l\xe0 m\xfaa r\xecu qua m\u1eaft th\u1ee3 nh\u01b0ng hy v\u1ecdng n\xf3 s\u1ebd gi\xfap cho c\xe1c b\u1ea1n fresher, junior gi\u1ea3i quy\u1ebft \u0111\u01b0\u1ee3c v\u1ea5n \u0111\u1ec1 v\u1ec1 Docker image size qu\xe1 l\u1edbn."),(0,i.mdx)("h3",null,"V\xed d\u1ee5 minh h\u1ecda"),(0,i.mdx)("p",null,"\u0110\u1ec3 cho d\u1ec5 h\xecnh dung, m\xecnh s\u1ebd l\u1ea5y m\u1ed9t Dockerfile \u0111i\u1ec3n h\xecnh c\u1ee7a Ruby on Rails \u0111\u1ec3 l\xe0m v\xed d\u1ee5, c\xf3 th\u1ec3 s\u1ebd thi\u1ebfu v\xe0 th\u1eeba m\u1ed9t ch\xfat x\xedu."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"# K\u1ebf th\u1eeba build base l\xe0 image c\u1ee7a ruby:2.5.3 phi\xean b\u1ea3n \u0111\u1ea7y \u0111\u1ee7, official tr\xean Docker Hub.\nFROM ruby:2.5.3\n\n# Ch\u1ea1y hai l\u1ec7nh apt-get (qu\u1ea3n l\xfd package c\u1ee7a Ubuntu) \u0111\u1ec3 c\xe0i nodejs (c\u1ea7n trong qu\xe1 tr\xecnh build assets js, css c\u1ee7a web), v\xe0 build-base (build rubygems)\nRUN apt-get update\nRUN apt-get install -y nodejs build-base\n\n# Thi\u1ebft l\u1eadp m\u1ed9t s\u1ed1 bi\u1ebfn m\xf4i tr\u01b0\u1eddng cho Docker container.\nENV RAILS_ENV ${RAILS_ENV}\nENV APP_HOME /code\n\n# T\u1ea1o th\u01b0 m\u1ee5c WORKDIR l\u1ea5y t\u1eeb ENV APP_HOME, m\u1eb7c \u0111\u1ecbnh \u1edf tr\xean l\xe0 /code\nRUN mkdir $APP_HOME\nWORKDIR $APP_HOME\n\n# Get dependencies c\u1ee7a Rails\nADD Gemfile* $APP_HOME/\nRUN bundle install - jobs 4\n\n# Copy h\u1ebft th\u01b0 m\u1ee5c hi\u1ec7n t\u1ea1i v\xe0o th\u01b0 m\u1ee5c WORKDIR\nADD . $APP_HOME\n\n# Docker container m\u1edf port 3000\nEXPOSE 3000\n\n# Command run app\nCMD bundle exec puma -C config/puma.rb\n")),(0,i.mdx)("h2",null,"C\xe1ch gi\u1ea3m dung l\u01b0\u1ee3ng Docker image"),(0,i.mdx)("h3",null,"Ki\u1ec3m tra dung l\u01b0\u1ee3ng Docker image"),(0,i.mdx)("p",null,"M\xecnh build Dockerfile \u1edf tr\xean, l\u1ec7nh list docker images s\u1ebd cho ta th\u1ea5y dung l\u01b0\u1ee3ng c\u1ee7a image \u1edf c\u1ed9t cu\u1ed1i c\xf9ng."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"\u2570\u2500 docker images | head -2\nREPOSITORY       TAG        IMAGE ID       CREATED              SIZE\nntloi            latest     2343d383ebca  About ...ago        1.12GB\n")),(0,i.mdx)("p",null,"What? 1.12 GB =))"),(0,i.mdx)("p",null,"\u0110\u1ec3 hi\u1ec3u r\xf5 t\u1ea1i sao l\u1ea1i to nh\u01b0 v\u1eady ta d\xf9ng l\u1ec7nh docker history. (Th\u1ee9 t\u1ef1 c\xe1c c\xe2u l\u1ec7nh s\u1ebd b\u1ecb ng\u01b0\u1ee3c so v\u1edbi Docker file, do c\xe1c layer stack l\xean nhau)."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},'\u2570\u2500 docker history ntloi:latest\nCREATED BY                                      SIZE\n/bin/sh -c #(nop)  CMD ["/bin/sh" "-c" "bund\u2026   0B\n/bin/sh -c #(nop)  EXPOSE 3000                  0B\n/bin/sh -c #(nop) ADD dir:0c93aceee1fd93e794\u2026   52.3MB\n/bin/sh -c bundle install --jobs 4              158MB\n...\n/bin/sh -c apt-get install -y nodejs --no-in\u2026   16.5MB\n/bin/sh -c apt-get update                       16.4MB\n...\n/bin/sh -c set -ex   && buildDeps=\'   bison \u2026   37.7MB\n...\n/bin/sh -c mkdir -p /usr/local/etc  && {   e\u2026   45B\n/bin/sh -c set -ex;  apt-get update;  apt-ge\u2026   562MB\n/bin/sh -c apt-get update && apt-get install\u2026   142MB\n/bin/sh -c set -ex;  if ! command -v gpg > /\u2026   7.81MB\n/bin/sh -c apt-get update && apt-get install\u2026   23.2MB\n...\n/bin/sh -c #(nop) ADD file:e4bdc12117ee95eaa\u2026   101MB\n')),(0,i.mdx)("h3",null,"D\xf9ng alpine image"),(0,i.mdx)("p",null,"R\xf5 r\xe0ng l\xe0 c\xe1c layer in \u0111\u1eadm kh\xf4ng ph\u1ea3i m\xecnh t\u1ea1o ra. N\xf3 l\xe0 layer c\u1ee7a c\xe2u l\u1ec7nh \u0111\u1ea7u ti\xean trong Dockerfile: ",(0,i.mdx)("inlineCode",{parentName:"p"},"FROM ruby:2.5.3")," (G\u1ea7n 900 MB)."),(0,i.mdx)("p",null,"Gi\u1ea3i quy\u1ebft v\u1ea5n \u0111\u1ec1 n\xe0y ta c\xf3 th\u1ec3 d\xf9ng c\xe1c images ruby kh\xe1c nh\u1eb9 h\u01a1n, nh\u1eb9 nh\u1ea5t \u1edf \u0111\xe2y l\xe0 nh\xf3m alpine. C\xf3 th\u1ec3 b\u1ea1n ch\u01b0a bi\u1ebft alpine l\xe0 b\u1ea3n ph\xe2n ph\u1ed1i linux nh\u1eb9 b\u1eadc nh\u1ea5t. V\xe0 ruby 2.5.3 c\xe0i tr\xean alpine c\u1ee1 ~ 22 MB. Nh\u01b0ng \u0111\xe1nh \u0111\u1ed5i v\xe0o \u0111\xf3 l\xe0 b\u1ea3n linux n\xe0y thi\u1ebfu th\u01b0 vi\u1ec7n nhi\u1ec1u l\u1eafm. N\xean mu\u1ed1n compile \u0111\u01b0\u1ee3c h\u1ebft ruby gem v\u1eabn ph\u1ea3i install c\xe1c th\u01b0 vi\u1ec7n. Tuy nhi\xean v\u1eabn ti\u1ebft ki\u1ec7m \u0111\u01b0\u1ee3c dung l\u01b0\u1ee3ng r\u1ea5t nhi\u1ec1u. Dockerfile l\xfac n\xe0y:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"FROM ruby:2.5.3-alpine3.8\n\nRUN apk add --update build-base tzdata\n\nENV RAILS_ENV ${RAILS_ENV}\nENV APP_HOME /code\n\nRUN mkdir $APP_HOME\n\nWORKDIR $APP_HOME\n\nADD Gemfile* $APP_HOME/\nRUN bundle install --jobs 4\n\nADD . $APP_HOME\n\nEXPOSE 3000\n\nCMD bundle exec puma -C config/puma.rb\n")),(0,i.mdx)("p",null,"Sau khi build:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"\u2570\u2500 docker images | head -2\nREPOSITORY       TAG        IMAGE ID      CREATED              SIZE\nntloi            latest     688dc4bc5a1a  8 seconds ago        398MB\n")),(0,i.mdx)("h3",null,"Multi-stage build"),(0,i.mdx)("p",null,"Sau khi d\xf9ng ",(0,i.mdx)("inlineCode",{parentName:"p"},"ruby-alpine")," \u0111\u1ec3 build th\xec ta xem l\u1ea1i docker history. Ta th\u1ea5y dung l\u01b0\u1ee3ng image v\u1eabn c\xf2n l\u1edbn (g\u1ea7n ~400 MB). Nhi\u1ec1u nh\u1ea5t l\xe0 l\u1ec7nh:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"apk add \u2014 update build-base tzdata\n")),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},'\u2570\u2500 docker history\nntloi:latestCREATED BY                                 SIZE\n/bin/sh -c #(nop)  CMD ["/bin/sh" "-c" "bund\u2026          0B\n/bin/sh -c #(nop)  EXPOSE 3000                         0B\n/bin/sh -c #(nop)  ENV SECRET_KEY_BASE=$(rak\u2026          0B\n/bin/sh -c #(nop)  ADD dir:946653e21b282f5a10\u2026         52.3MB\n/bin/sh -c bundle install --jobs 4                     145MB\n/bin/sh -c apk add --update build-base tzdata          154MB\n')),(0,i.mdx)("p",null,"Trong qu\xe1 tr\xecnh build app Ruby on Rails c\xe1c th\u01b0 vi\u1ec7n, ph\u1ea7n m\u1ec1m trong build-base r\u1ea5t c\u1ea7n thi\u1ebft. Tuy nhi\xean l\xfac run app th\xec c\xe1c th\u01b0 vi\u1ec7n n\xe0y kh\xf4ng c\u1ea7n thi\u1ebft n\u1eefa. Do \u0111\xf3 ta n\xean t\xe1ch qu\xe1 tr\xecnh build l\xe0 2 ph\u1ea7n: Prebuild v\xe0 build nh\u1edd v\xe0o ",(0,i.mdx)("a",{href:"https://docs.docker.com/develop/develop-images/multistage-build/",parentName:"p"},"multi-stage build"),". Ta s\u1ebd gi\u1ea3m \u0111\u01b0\u1ee3c 154 MB c\u1ee7a build-base."),(0,i.mdx)("h3",null,"X\xf3a c\xe1c files kh\xf4ng c\u1ea7n thi\u1ebft"),(0,i.mdx)("ul",null,(0,i.mdx)("li",{parentName:"ul"},"D\xf9ng file .dockerignore"),(0,i.mdx)("li",{parentName:"ul"},"X\xf3a c\xe1c file cache v\xe0 c\xe1c file C \u0111\u1ec3 compile th\u01b0 vi\u1ec7n. L\xfac \u0111\xe3 bi\xean d\u1ecbch th\u01b0 vi\u1ec7n Ruby r\u1ed3i th\xec khi run app, ta kh\xf4ng c\u1ea7n c\xe1c file n\xe0y n\u1eefa."),(0,i.mdx)("li",{parentName:"ul"},"N\u1ebfu trong m\xf4i tr\u01b0\u1eddng Production, ta c\u0169ng ko nh\u1ea5t thi\u1ebft c\u1ea7n c\xe1c file ki\u1ec3u nh\u01b0 README.txt, spec, test,\u2026. H\xe3y x\xf3a ch\xfang \u0111i. C\xe1c th\u01b0 m\u1ee5c c\xf3 th\u1ec3 x\xf3a trong m\xf4i tr\u01b0\u1eddng Production bao g\u1ed3m: spec, node_modules, app/assets, vendor/assets, lib/assets, tmp/cache, app/bin v\xe0 c\xe1c file text nh\u01b0 README.txt")),(0,i.mdx)("p",null,"Dockerfile ho\xe0n thi\u1ec7n."),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},'# ----------------------- STAGE 1 PRE-BUILD -----------------\nFROM ruby:2.5.3-alpine3.8 AS pre-builder\n\nENV RAILS_ENV ${RAILS_ENV}\nENV APP_HOME /code ENV BUNDLE_PATH /gems\n\nRUN apk add --update build-base tzdata \\\n    && mkdir $APP_HOME\n\nWORKDIR $APP_HOME\n\nADD . $APP_HOME \\\n    && Gemfile* $APP_HOME/\n\nRUN bundle install --jobs 4\n\n# X\xf3a c\xe1c file .o v\xe0 file .c sau khi \u0111\xe3 build xong gem.\n# C\xe1c b\u1ea1n c\xf3 bi\u1ebft Ruby \u0111\u01b0\u1ee3c vi\u1ebft b\u1eb1ng C kh\xf4ng h\u1ea3 :))\nRUN rm -rf /gems/cache/*.gem  \\\n    && find /gems/gems/ -name "*.c" -delete \\\n    && find /gems/gems/ -name "*.o" -delete\n\n# ------------------------ STAGE 2 BUILD --------------------\nFROM ruby:2.5.3-alpine3.8\n\nENV APP_HOME /code\nENV BUNDLE_PATH /gems\n\nRUN apk add --update tzdata\nARG RAILS_ENV=development\nENV RAILS_ENV ${RAILS_ENV}\nWORKDIR $APP_HOME\n\n# Copy l\u1ea1i h\u1ebft nh\u1eefng g\xec \u0111\xe3 build t\u1eeb stage 1.\nCOPY --from=pre-builder $APP_HOME $APP_HOME \\\n     && --from=pre-builder $BUNDLE_PATH $BUNDLE_PATH\n\nEXPOSE 3000\n\nCMD bundle exec puma -C config/puma.rb\n')),(0,i.mdx)("p",null,"Sau khi build:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"\u2570\u2500 docker images | head -2\nREPOSITORY       TAG        IMAGE ID      CREATED              SIZE\nntloi        latest     752fa284cb41     About a minute ago   124MB\n")),(0,i.mdx)("p",null,"124 MB nh\xe9. File ",(0,i.mdx)("inlineCode",{parentName:"p"},".dockerignore")," tham kh\u1ea3o"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},".env*\n.git\n.gitignore\n.codeclimate.yml\n.dockerignore\n.gitlab-ci.yml\n.hound.yml\n.travis.yml\nLICENSE.md\nREADME.md\ndocker-compose.*\nDockerfile\nlog/*\nnode_modules/*\npublic/assets/*\nstorage/*\npublic/packs/*\npublic/packs-test/*\ntmp/*\n")),(0,i.mdx)("h2",null,"M\u1ed9t s\u1ed1 l\u01b0u \xfd kh\xe1c khi vi\u1ebft Dockerfile"),(0,i.mdx)("h3",null,"T\u1eadn d\u1ee5ng c\xe1c layer cache"),(0,i.mdx)("p",null,"Ch\xfang ta \u0111\u1ec1u bi\u1ebft Docker image bao g\u1ed3m nhi\u1ec1u layer x\u1ebfp ch\u1ed3ng l\xean nhau. \u0110\u1ec3 Docker build nhanh h\u01a1n ch\xfang ta n\xean t\u1eadn d\u1ee5ng vi\u1ec7c cache c\xe1c layer c\u1ee7a c\xe1c image \u0111\xe3 build tr\u01b0\u1edbc \u0111\xf3. Ta c\xf3 th\u1ec3 d\u1ec5 d\xe0ng nh\xecn th\u1ea5y li\u1ec7u 1 layer c\xf3 \u0111\u01b0\u1ee3c cache hay kh\xf4ng nh\u1edd v\xe0o c\xe1c d\xf2ng log \u0111\u01b0\u1ee3c in ra trong qu\xe1 tr\xecnh build.\nN\u1ebfu m\u1ed9t layer n\u1eb1m \u1edf d\u01b0\u1edbi thay \u0111\u1ed5i th\xec c\xe1c layer \u1edf tr\xean \u0111\u1ec1u ph\u1ea3i build m\u1edbi l\u1ea1i ch\u1ee9 kh\xf4ng th\u1ec3 d\xf9ng cache. Do \u0111\xf3, ta n\xean \u0111\u1eb7t c\xe1c b\u01b0\u1edbc \xedt thay \u0111\u1ed5i l\xean tr\xean \u0111\u1ea7u Dockerfile \u0111\u1ec3 d\xf9ng \u0111\u01b0\u1ee3c cache, t\u1eeb \u0111\xf3 t\u0103ng t\u1ed1c \u0111\u1ed9 build Docker image."),(0,i.mdx)("h3",null,"Gi\u1ea3m s\u1ed1 l\u01b0\u1ee3ng layer"),(0,i.mdx)("p",null,"Th\u1eadt ra t\u1edbi khi t\xecm hi\u1ec3u v\xe0 vi\u1ebft b\xe0i th\xec m\xecnh m\u1edbi bi\u1ebft \u0111\u01b0\u1ee3c \u0111i\u1ec1u n\xe0y. Docker image c\xe0ng nhi\u1ec1u layer th\xec c\xe0ng c\u1ed3ng k\u1ec1nh (c\xf3 t\u0103ng size, t\u0103ng build time kh\xf4ng th\xec m\xecnh ch\u01b0a ki\u1ec3m ch\u1ee9ng). Do \u0111\xf3 ch\xfang ta c\u1ea7n ph\u1ea3i gi\u1ea3m b\u1edbt s\u1ed1 l\u01b0\u1ee3ng layer khi c\xf3 th\u1ec3."),(0,i.mdx)("p",null,"C\xf3 3 l\u1ec7nh t\u1ea1o ra Docker layer l\xe0: ",(0,i.mdx)("strong",{parentName:"p"},"RUN"),", ",(0,i.mdx)("strong",{parentName:"p"},"COPY"),", ",(0,i.mdx)("strong",{parentName:"p"},"ADD"),". Cho n\xean vi\u1ec7c vi\u1ebft nh\u01b0 th\u1ebf n\xe0y:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"RUN bundle exec rake assets:clean\nRUN bundle exec rake assets:precompile\nRUN rm -rf /gems/cache/*.gem\n")),(0,i.mdx)("p",null,"S\u1ebd kh\xf4ng t\u1ed1t b\u1eb1ng vi\u1ebft th\u1ebf n\xe0y:"),(0,i.mdx)("pre",null,(0,i.mdx)("code",{parentName:"pre"},"RUN bundle exec rake assets:clean \\\n&& bundle exec rake assets:precompile \\\n&& rm -rf /gems/cache/*.gem\n")),(0,i.mdx)("p",null,"C\xf3 m\u1ed9t ch\xfat l\u01b0u \xfd l\xe0 vi\u1ec7c gom c\xe1c l\u1ec7nh n\xe0y l\u1ea1i s\u1ebd c\xf3 th\u1ec3 \u1ea3nh h\u01b0\u1edfng \u0111\u1ebfn vi\u1ec7c cache layer \u1edf tr\xean. Do ch\u1ec9 c\u1ea7n 1 trong 3 c\xe2u l\u1ec7nh g\u1ed9p n\xe0y thay \u0111\u1ed5i c\u0169ng \u0111\u1ed3ng ngh\u0129a v\u1edbi vi\u1ec7c c\u1ea3 3 l\u1ec7nh n\xe0y ph\u1ea3i b\u1ecb ch\u1ea1y l\u1ea1i v\xe0 ko th\u1ec3 d\xf9ng cache. Khi gom l\u01b0u \xfd t\xed x\xedu l\xe0 \u0111\u01b0\u1ee3c."),(0,i.mdx)("p",null,"Hi v\u1ecdng b\xe0i vi\u1ebft h\u1eefu \xedch cho c\xe1c b\u1ea1n."),(0,i.mdx)("p",null,"Ref: ",(0,i.mdx)("a",{href:"https://thecode.pub/reduce-your-docker-images-an-example-with-ruby-564735f4388c",parentName:"p"},"https://thecode.pub/reduce-your-docker-images-an-example-with-ruby-564735f4388c")))}u.isMDXComponent=!0,e.default=u}},function(n){n.O(0,[774,686,888,179],(function(){return e=8271,n(n.s=e);var e}));var e=n.O();_N_E=e}]);