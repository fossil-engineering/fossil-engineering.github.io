<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta content="width=device-width, initial-scale=1" name="viewport"/><title>Tuning ElasticSearch storage</title><meta name="robots" content="follow, index"/><meta name="description" content="Việc tối ưu bộ nhớ cho Database rất quan trọng đối với 1 Data Engineer, sau đây mình sẽ chia sẻ những cách mà Fossil đã sử dụng để tối ưu bộ nhớ cho ElasticSearch"/><meta property="og:url" content="https://fossil-engineering.github.io/blog/tuning-es-storage"/><meta property="og:type" content="article"/><meta property="og:site_name" content="Fossil Engineering"/><meta property="og:description" content="Việc tối ưu bộ nhớ cho Database rất quan trọng đối với 1 Data Engineer, sau đây mình sẽ chia sẻ những cách mà Fossil đã sử dụng để tối ưu bộ nhớ cho ElasticSearch"/><meta property="og:title" content="Tuning ElasticSearch storage"/><meta property="og:image" content="https://fossil-engineering.github.io/static/img/twitter-card.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:site" content=""/><meta name="twitter:title" content="Tuning ElasticSearch storage"/><meta name="twitter:description" content="Việc tối ưu bộ nhớ cho Database rất quan trọng đối với 1 Data Engineer, sau đây mình sẽ chia sẻ những cách mà Fossil đã sử dụng để tối ưu bộ nhớ cho ElasticSearch"/><meta name="twitter:image" content="https://fossil-engineering.github.io/static/img/twitter-card.png"/><meta property="article:published_time" content="2022-07-29T00:00:00.000Z"/><link rel="canonical" href="https://fossil-engineering.github.io/blog/tuning-es-storage"/><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "Article",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://fossil-engineering.github.io/blog/tuning-es-storage"
  },
  "headline": "Tuning ElasticSearch storage",
  "image": [
    {
      "@type": "ImageObject",
      "url": "https://fossil-engineering.github.io/static/img/twitter-card.png"
    }
  ],
  "datePublished": "2022-07-29T00:00:00.000Z",
  "dateModified": "2022-07-29T00:00:00.000Z",
  "author": [
    {
      "@type": "Person",
      "name": "Vu Duy Khanh"
    }
  ],
  "publisher": {
    "@type": "Organization",
    "name": "",
    "logo": {
      "@type": "ImageObject",
      "url": "https://fossil-engineering.github.ioundefined"
    }
  },
  "description": "Việc tối ưu bộ nhớ cho Database rất quan trọng đối với 1 Data Engineer, sau đây mình sẽ chia sẻ những cách mà Fossil đã sử dụng để tối ưu bộ nhớ cho ElasticSearch"
}</script><meta name="next-head-count" content="19"/><link rel="apple-touch-icon" sizes="180x180" href="/static/favicons/apple-touch-icon.png"/><link rel="icon" type="image/png" sizes="32x32" href="/static/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="16x16" href="/static/favicons/favicon-16x16.png"/><link rel="manifest" href="/static/favicons/site.webmanifest"/><link rel="mask-icon" href="/static/favicons/safari-pinned-tab.svg" color="#5bbad5"/><meta name="msapplication-TileColor" content="#2b5797"/><meta name="theme-color" content="#ffffff"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"/><link rel="preconnect" href="https://rsms.me" crossorigin="anonymous"/><link rel="stylesheet" href="https://rsms.me/inter/inter.css"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/f370531b7073626a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/f370531b7073626a.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-ac8892dbacacc40f.js" defer=""></script><script src="/_next/static/chunks/framework-109a728694328ca8.js" defer=""></script><script src="/_next/static/chunks/main-3f06473b4f311d12.js" defer=""></script><script src="/_next/static/chunks/pages/_app-33f3255677f3c86d.js" defer=""></script><script src="/_next/static/chunks/459-6dc512909c4bb933.js" defer=""></script><script src="/_next/static/chunks/410-28e8636dde5f4fea.js" defer=""></script><script src="/_next/static/chunks/620-4ffca7d07d13ee0d.js" defer=""></script><script src="/_next/static/chunks/pages/blog/%5B...slug%5D-0a1bff3ee9d6b739.js" defer=""></script><script src="/_next/static/YdCaCMbXHg7ZfyRqMsMQm/_buildManifest.js" defer=""></script><script src="/_next/static/YdCaCMbXHg7ZfyRqMsMQm/_ssgManifest.js" defer=""></script><style data-href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuLyfMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuGKYMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcCO3FwrK3iLTeHuS_fvQtMwCp50KnMw2boKoduKmMEVuFuYMZs.woff) format('woff')}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:600;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2JL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa0ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2ZL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+1F00-1FFF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0370-03FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa2pL7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa25L7W0Q5n-wU.woff2) format('woff2');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Inter';font-style:normal;font-weight:700;font-display:swap;src:url(https://fonts.gstatic.com/s/inter/v12/UcC73FwrK3iLTeHuS_fvQtMwCp50KnMa1ZL7W0Q5nw.woff2) format('woff2');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body class="antialiased text-black bg-white dark:bg-gray-900 dark:text-white"><div id="__next"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&true)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}if(e==='light'||e==='dark')d.style.colorScheme=e}catch(e){}}()</script><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex flex-col justify-between h-screen"><header class="flex items-center justify-between py-10"><div><a aria-label="Fossil Engineering" href="/"><div class="flex items-center justify-between"><div class="mr-3 logo"><svg xmlns="http://www.w3.org/2000/svg" width="132.393" height="25.507" xml:space="preserve"><path d="M89.751 10.925c-4.768-1.529-6.842-2.877-6.486-5.096.342-2.201 2.729-2.07 5.047-1.89 2.291.192 4.158.701 5.52 1.148.025.018.105-.004.121-.082.121-.806.559-2.943.678-3.675.018-.091-.068-.136-.113-.147C91.729.428 89.182-.052 86.137.004c-5.703.099-8.354 2.396-8.678 7.192-.191 2.799 1.748 5.893 5.777 7.227 4.029 1.334 6.904 2.087 6.486 4.57-.369 2.104-2.85 2.342-5.539 2.187-2.355-.144-4.348-.705-5.834-1.156-.107-.032-.172.021-.197.119-.111.864-.424 3.071-.531 3.849-.004.104.084.188.129.198 1.859.445 5.15 1.07 9.197 1.07 5.473 0 8.312-2.347 8.631-6.841.247-3.487-1.395-6.067-5.827-7.494zM65.068 10.925c-4.771-1.529-6.839-2.877-6.485-5.096.344-2.201 2.729-2.07 5.04-1.89 2.292.192 4.16.701 5.517 1.148.039.018.096-.004.113-.082.139-.806.566-2.943.691-3.675a.139.139 0 0 0-.111-.147C67.04.428 64.494-.052 61.454.004 55.75.103 53.101 2.4 52.766 7.196c-.188 2.8 1.753 5.896 5.774 7.23 4.024 1.334 6.898 2.086 6.494 4.567-.367 2.105-2.846 2.342-5.539 2.188-2.366-.142-4.346-.707-5.842-1.156-.096-.032-.168.021-.188.117-.11.867-.425 3.073-.53 3.853-.003.102.075.188.124.196a40.142 40.142 0 0 0 9.191 1.07c5.478 0 8.31-2.347 8.632-6.843.256-3.486-1.387-6.066-5.814-7.493zM17.998.555H1.468a.157.157 0 0 0-.162.155v23.971c0 .088.064.16.162.16H6.96a.156.156 0 0 0 .155-.16V15.71c0-.082.072-.16.162-.16h9.525c.092 0 .164-.064.164-.15v-3.708a.165.165 0 0 0-.164-.165H7.277a.16.16 0 0 1-.162-.162V4.74c0-.085.072-.16.162-.16h10.861a.154.154 0 0 0 .156-.157L18.168.711c-.012-.08-.09-.156-.17-.156zM109.023.537h-5.666c-.1 0-.16.068-.16.156v23.991c0 .084.061.149.16.149h5.666c.09 0 .154-.065.154-.149V.693a.152.152 0 0 0-.154-.156zM133.536 20.742h-9.395a.16.16 0 0 1-.158-.156L123.981.732c0-.099-.066-.161-.16-.161h-5.658a.157.157 0 0 0-.162.161v23.951c0 .084.076.147.162.147h15.186c.088 0 .164-.063.168-.147l.182-3.772c-.002-.098-.065-.169-.163-.169zM35.363.026c-7.436 0-11.493 4.878-11.493 12.743 0 7.857 4.059 12.738 11.493 12.738 7.433 0 11.487-4.881 11.487-12.738C46.85 4.787 42.901.026 35.363.026zm0 21.462c-5.05 0-5.749-4.193-5.749-8.719 0-4.52.699-8.714 5.749-8.714 5.044 0 5.738 4.192 5.738 8.714 0 4.525-.694 8.719-5.738 8.719z"></path></svg></div></div></a></div><div class="flex items-center text-base leading-5"><div class="hidden sm:block"><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/blog">Blog</a><a class="p-1 font-medium text-gray-900 sm:p-4 dark:text-gray-100" href="/about">About</a></div><button aria-label="Toggle Dark Mode" type="button" class="w-8 h-8 p-1 ml-1 mr-1 rounded sm:ml-4"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg></button><div class="sm:hidden"><button type="button" class="w-8 h-8 py-1 ml-1 mr-1 rounded" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="fixed w-full h-full top-24 right-0 bg-gray-200 dark:bg-gray-800 opacity-95 z-10 transform ease-in-out duration-300 translate-x-full"><button type="button" aria-label="toggle modal" class="fixed w-full h-full cursor-auto focus:outline-none"></button><nav class="fixed h-full mt-8"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/blog">Blog</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 dark:text-gray-100" href="/about">About</a></div></nav></div></div></div></header><main class="mb-auto"><div class="max-w-3xl px-4 mx-auto sm:px-6 xl:max-w-5xl xl:px-0"><article><div class="xl:divide-y xl:divide-gray-200 xl:dark:divide-gray-700"><header class="pt-6 xl:pb-6"><div class="space-y-1 text-center"><dl class="space-y-10"><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2022-07-29T00:00:00.000Z">Friday, July 29, 2022</time></dd></div></dl><div><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">Tuning ElasticSearch storage</h1></div></div></header><div class="pb-8 divide-y divide-gray-200 xl:divide-y-0 dark:divide-gray-700 xl:grid xl:grid-cols-4 xl:gap-x-6" style="grid-template-rows:auto 1fr"><dl class="pt-6 pb-10 xl:pt-11 xl:border-b xl:border-gray-200 xl:dark:border-gray-700"><dt class="sr-only">Authors</dt><dd><ul class="flex justify-center space-x-8 xl:block sm:space-x-12 xl:space-x-0 xl:space-y-8"><li class="flex items-center space-x-2"><span style="box-sizing:border-box;display:inline-block;overflow:hidden;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;position:relative;max-width:100%"><span style="box-sizing:border-box;display:block;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0;max-width:100%"><img style="display:block;max-width:100%;width:initial;height:initial;background:none;opacity:1;border:0;margin:0;padding:0" alt="" aria-hidden="true" src="data:image/svg+xml,%3csvg%20xmlns=%27http://www.w3.org/2000/svg%27%20version=%271.1%27%20width=%2738%27%20height=%2738%27/%3e"/></span><img alt="avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" data-nimg="intrinsic" class="w-10 h-10 rounded-full" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/><noscript><img alt="avatar" srcSet="https://avatars.githubusercontent.com/u/32119373?v=4?imwidth=48 1x, https://avatars.githubusercontent.com/u/32119373?v=4?imwidth=96 2x" src="https://avatars.githubusercontent.com/u/32119373?v=4?imwidth=96" decoding="async" data-nimg="intrinsic" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="w-10 h-10 rounded-full" loading="lazy"/></noscript></span><dl class="text-sm font-medium leading-5 whitespace-nowrap"><dt class="sr-only">Name</dt><dd class="text-gray-900 dark:text-gray-100"><a href="/author/khanh">Vu Duy Khanh</a></dd><dt class="sr-only">Twitter</dt><dd><a target="_blank" rel="noopener noreferrer" href="https://github.com/DuyKhanhVu" class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400">@DuyKhanhVu</a></dd></dl></li></ul></dd></dl><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:pb-0 xl:col-span-3 xl:row-span-2"><div class="pt-10 pb-8 prose dark:prose-dark max-w-none"><p><strong>Fossil đã điều chỉnh và tối ưu bộ nhớ cho cụm Elasticsearch như thế nào?</strong></p>
<p>Bối cảnh</p>
<p>Fossil Việt Nam là một trung tâm nghiên cứu nên logs là một phần rất quan trọng. Chính vì vậy logs cần được truy xuất nhanh để đáp ứng những nhu cầu như debug hardware, QA test cũng như CS team có thể kiểm tra log để giúp đỡ user trong lúc sử dụng app, ... Trước đây, logs sau khi ETL thì được lưu ở S3 và sau đó sử dụng Athena để truy xuất, vấn đề xuất hiện khi dùng Athena truy xuất càng nhiều thì sẽ tốn chi phí query, cùng với đó với lượng dữ liệu lớn Athena thường cho kết quả khá lâu. Với những yêu cầu đó mình lựa chọn Elasticsearch (ES) để lưu trữ và trích xuất log.</p>
<p>ES không còn quá xa lạ đặc biệt là đối với các Data Engineer trong bài này mình sẽ không nói đến việc ES làm việc như thế nào mà mình sẽ đề cập đến một vấn đề khi cài đặt ES trên k8s mà mình đã gặp phải đó là tunning storage cho es cluster. Chúng ta đã biết vì es sẽ index dữ liệu của chúng ta để tăng tốc độ truy xuất cho nên kích thước sẽ tăng đáng kể so với dữ liệu được lưu ở các storage khác như S3 hay GCS và kích thước ở đây lại chính là đĩa ở k8s cho nên chúng ta sẽ phải cân đối các config để vừa đáp ứng với nhu cầu và tốc độ truy xuất dữ liệu. Với Fossil, dữ liệu ở dạng json, nhu cầu search chính xác giá trị đối với một số fields ví dụ như (userid, testid, ...).</p>
<p>Khi không sử dụng template</p>
<div class="relative"><pre><code class="language-bash">GET localhost:9200/_cat/indices?v=true&amp;s=index

index                       pri rep docs.count store.size pri.store.size
sdk_log-2022-03-14            1   1     324105    202.2mb        202.2mb
</code></pre></div>
<p>Và dưới đây là dẫn chứng cho ta thấy tầm quan trọng của ES template</p>
<p>Đầu tiên chúng ta thay đổi <strong>compression type.</strong> Mặc định ES là LZ4 sẽ được áp dụng, chúng ta có thể áp dụng <code>best_compression</code> sử dụng DEFLATE giúp tỉ lệ nén cao hơn nhưng sẽ dẫn tới việc thời gian nén lâu hơn. Tuy nhiên điều này có thể chấp nhận được trong bối cảnh chúng ta đang cần ưu tiên tối ưu bộ nhớ ...</p>
<div class="relative"><pre><code class="language-bash">PUT localhost:9200/_template/sdk_log

{
    &quot;index_patterns&quot;: [
        &quot;sdk_log-*&quot;
    ],
    &quot;settings&quot;: {
        &quot;codec&quot;: &quot;best_compression&quot;,
        &quot;merge.policy.max_merged_segment&quot;: &quot;5mb&quot;
    }
}
</code></pre></div>
<p>~13% bộ nhớ được thu nhỏ khi dùng <code>best_compression</code></p>
<div class="relative"><pre><code class="language-bash">GET localhost:9200/_cat/indices?v=true&amp;s=index

index                                pri rep docs.count store.size pri.store.size
sdk_log_best_compression-2022-03-14    1   1     324105    175.4mb        175.4mb

</code></pre></div>
<p>Tiếp theo ta cần đi sâu một chút tìm hiểu khái niệm <strong>Mapping</strong>. Mapping là một quy trình để định nghĩa một bản ghi và cách mà các fields sẽ được quản lý, lưu trữ và lập chỉ mục. Vì vậy với mỗi mapping khác nhau sẽ dẫn đến không gian lưu trữ và hiệu suất khác nhau.</p>
<p>Sau đây là 3 tham số mình đã dùng để tối ưu bộ nhớ.</p>
<p><strong>Field data types</strong></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html#mapping-types">https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html#mapping-types</a></p>
<p>Mỗi field sẽ có một <em>field data type</em> nó chỉ ra loại dữ liệu của field đó. Kiểu dữ liệu chúng ta dùng nhiều nhất với ES là kiểu chuỗi (string) nên chúng ta cần hiểu rõ hai loại <strong>text</strong> và <strong>keyword</strong>. Với text field dữ liệu sẽ được phân tích để đáp ứng nhu cầu full-text search trong khi với keyword dữ liệu được giữ nguyên để đáp ứng việc sắp xếp và lọc dữ liệu. Vậy nên tùy vào nhu cầu truy xuất bạn hãy chọn kiểu dữ liệu cho các field một cách hợp lý, theo mình hạn chế dùng text file những field cho nhu cầu tìm kiếm gần đúng như title, content, … ta nên dùng text field, còn lại những field yêu cầu tìm kiếm chính xác match 100% chúng ta sẽ dùng keyword.</p>
<p>Các field types được nhóm lại theo <em>family</em>. Các loại dữ liệu cùng <em>family</em> sẽ có phương thức truy xuất hoàn toàn giống nhau nhưng sẽ có sự khác nhau về không gian lưu trữ và hiệu suất.</p>
<p>Ví dụ chúng ta config kiểu dữ liệu cho trường dữ liệu brand.</p>
<div class="relative"><pre><code class="language-bash">PUT localhost:9200/_template/sdk_log

{
    &quot;index_patterns&quot;: [
        &quot;sdk_log-*&quot;
    ],
    &quot;settings&quot;: {
        &quot;codec&quot;: &quot;best_compression&quot;,
        &quot;merge.policy.max_merged_segment&quot;: &quot;5mb&quot;
    },
    &quot;mappings&quot;: {
        &quot;properties&quot;: {
            },
            &quot;brand&quot;: {
                &quot;type&quot;: &quot;text&quot;
            },
        }
    }
}
</code></pre></div>
<p><strong>doc_values</strong></p>
<p><a target="_blank" rel="noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.1/doc-values.html">https://www.elastic.co/guide/en/elasticsearch/reference/8.1/doc-values.html</a></p>
<p>Doc values là một kiểu dữ liệu trên đĩa (the on-disk data structure). Phần lớn các fields sẽ được mặc định lập chỉ mục (indexed) giúp chúng có thể tìm kiếm (searchable). <a target="_blank" rel="noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.1/number.html">Numeric types</a>, <a target="_blank" rel="noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.1/date.html">date types</a>, <a target="_blank" rel="noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.1/boolean.html">boolean type</a>, <a target="_blank" rel="noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.1/ip.html">ip type</a>, <a target="_blank" rel="noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.1/geo-point.html">geo_point type</a> và <a target="_blank" rel="noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.1/keyword.html">keyword type</a> vẫn có thể truy xuất khi chúng không được <a target="_blank" rel="noopener noreferrer" href="https://www.elastic.co/guide/en/elasticsearch/reference/8.1/mapping-index.html">indexed</a> mà chỉ có doc values được bật đó là khái niệm <strong>doc-value-only fileds</strong>. Hiệu suất truy xuất sẽ chậm hơn nhưng chúng ta có thể đánh đổi với không gian lưu trữ trên đĩa trong các trường hợp field đó ít khi được truy suất hoặc tốc độ truy xuất không quan trọng. Ở Fossil, ngay cả khi tốc độ truy xuất bị đánh đổi cơ bản nó vẫn nhanh hơn rất nhiều so với Athena.</p>
<p>Doc-value-only field có thể config như sau:</p>
<div class="relative"><pre><code class="language-bash">PUT localhost:9200/\_template/sdk_log
{
    &quot;index_patterns&quot;: [
        &quot;sdk_log-*&quot;
    ],
    &quot;settings&quot;: {
        &quot;codec&quot;: &quot;best_compression&quot;,
        &quot;merge.policy.max_merged_segment&quot;: &quot;5mb&quot;
    },
    &quot;mappings&quot;: {
        &quot;properties&quot;: {},
        &quot;brand&quot;: {
            &quot;type&quot;: &quot;text&quot;,
            &quot;index&quot;: &quot;false&quot;
        },
    }
}
</code></pre></div>
<p>Thậm chí nếu bạn không cần tổng hợp, sắp xếp hay thay đổi giá trị của một trường dữ liệu chúng ta có hoàn toàn có thể tắt doc values để tối ưu bộ nhớ.</p>
<div class="relative"><pre><code class="language-bash">PUT localhost:9200/\_template/sdk_log
{
    &quot;index_patterns&quot;: [
        &quot;sdk_log-*&quot;
    ],
    &quot;settings&quot;: {
        &quot;codec&quot;: &quot;best_compression&quot;,
        &quot;merge.policy.max_merged_segment&quot;: &quot;5mb&quot;
    },
    &quot;mappings&quot;: {
        &quot;properties&quot;: {},
        &quot;brand&quot;: {
            &quot;type&quot;: &quot;text&quot;,
            &quot;index&quot;: &quot;false&quot;,
            &quot;doc_values&quot;: &quot;false&quot;
        },
    }
}
</code></pre></div>
<p>Và chúng ta xem bộ nhớ đã giảm như thế nào:</p>
<div class="relative"><pre><code class="language-bash">GET localhost:9200/_cat/indices?v=true&amp;s=index

index                                pri rep docs.count store.size pri.store.size
sdk_log-disable_doc_values-2022-03-14  1   1     324105     82.9mb         82.9mb
</code></pre></div>
<p>~60% dung lượng bộ nhớ được tối ưu</p>
<p><strong>norms</strong></p>
<p>Norms lưu trữ các yếu tố chuẩn hóa khác nhau giúp ích cho việc tại thời điểm truy vấn có thể tính điểm dữ liệu khi truy vấn. Mặc dù hữu ích cho việc tính điểm, đáp ứng nhu cầu cho việc tìm kiếm gần đúng nhưng norms cần khá nhiều không gian trên đĩa. Vì vậy đối với những trường không có nhu cầu trên chúng ta có thể tắt norms như sau:</p>
<div class="relative"><pre><code class="language-bash">PUT localhost:9200/\_template/sdk_log
{
    &quot;index_patterns&quot;: [
        &quot;sdk_log-*&quot;
    ],
    &quot;settings&quot;: {
        &quot;codec&quot;: &quot;best_compression&quot;,
        &quot;merge.policy.max_merged_segment&quot;: &quot;5mb&quot;
    },
    &quot;mappings&quot;: {
        &quot;properties&quot;: {},
        &quot;brand&quot;: {
            &quot;type&quot;: &quot;text&quot;,
            &quot;index&quot;: &quot;false&quot;,
            &quot;doc_values&quot;: &quot;false&quot;
            &quot;norms&quot;: &quot;false&quot;
        },
    }
}
</code></pre></div>
<p>Thêm khoảng ~1% bộ nhớ được tối ưu:</p>
<div class="relative"><pre><code class="language-bash">GET localhost:9200/_cat/indices?v=true&amp;s=index

index                                pri rep docs.count store.size pri.store.size
sdk_log-disable_doc_values-2022-03-14  1   1     324105       80mb         80mb
</code></pre></div>
<h1>References</h1>
<p><a target="_blank" rel="noopener noreferrer" href="https://www.elastic.co/guide/index.html">https://www.elastic.co/guide/index.html</a></p></div><div class="pt-6 pb-6 text-sm text-gray-700 dark:text-gray-300"><a target="_blank" rel="nofollow" href="https://mobile.twitter.com/search?q=https%3A%2F%2Ffossil-engineering.github.io%2Fblog%2Ftuning-es-storage">Discuss on Twitter</a> • <a target="_blank" rel="noopener noreferrer" href="https://github.com/fossil-engineering/fossil-engineering.github.io/blob/master/data/blog/2022-07-29-tuning-es-storage.md">View on GitHub</a></div></div><footer><div class="text-sm font-medium leading-5 divide-gray-200 xl:divide-y dark:divide-gray-700 xl:col-start-1 xl:row-start-2"><div class="py-4 xl:py-8"><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Tags</h2><div class="flex flex-wrap"><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/engineering">engineering</a><a class="mr-3 text-sm font-medium uppercase text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/tags/data">data</a></div></div><div class="flex justify-between py-4 xl:block xl:space-y-8 xl:py-8"><div><h2 class="text-xs tracking-wide text-gray-500 uppercase dark:text-gray-400">Previous Article</h2><div class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400"><a href="/blog/apache-spark-behind-the-scienes">Apache Spark behind the scenes</a></div></div></div></div><div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" href="/blog">← Back to the blog</a></div></footer></div></div></article></div></main><footer><div class="flex flex-col items-center mt-16"><div class="flex mb-3 space-x-4"><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:people@fossil.com"><span class="sr-only">mail</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M2.003 5.884 10 9.882l7.997-3.998A2 2 0 0 0 16 4H4a2 2 0 0 0-1.997 1.884z"></path><path d="m18 8.118-8 4-8-4V14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8.118z"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/fossil-engineering"><span class="sr-only">github</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="text-sm text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://www.linkedin.com/company/fossilvietnamcareers/"><span class="sr-only">linkedin</span><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 dark:text-gray-200 hover:text-blue-500 dark:hover:text-blue-400 h-6 w-6"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433a2.062 2.062 0 0 1-2.063-2.065 2.064 2.064 0 1 1 2.063 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"></path></svg></a></div><div class="flex mb-2 space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>© 2022</div><div> • </div><a href="/">Fossil Engineering</a></div><div class="mb-8 text-sm text-gray-500 dark:text-gray-400"><a target="_blank" rel="noopener noreferrer" href="https://github.com/timlrx/tailwind-nextjs-starter-blog">Tailwind Nextjs Theme</a></div></div></footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"post":{"mdxSource":"var Component=(()=\u003e{var o=Object.create;var h=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var u=Object.getOwnPropertyNames;var p=Object.getPrototypeOf,m=Object.prototype.hasOwnProperty;var y=(t,n)=\u003e()=\u003e(n||t((n={exports:{}}).exports,n),n.exports),k=(t,n)=\u003e{for(var c in n)h(t,c,{get:n[c],enumerable:!0})},r=(t,n,c,s)=\u003e{if(n\u0026\u0026typeof n==\"object\"||typeof n==\"function\")for(let i of u(n))!m.call(t,i)\u0026\u0026i!==c\u0026\u0026h(t,i,{get:()=\u003en[i],enumerable:!(s=g(n,i))||s.enumerable});return t};var b=(t,n,c)=\u003e(c=t!=null?o(p(t)):{},r(n||!t||!t.__esModule?h(c,\"default\",{value:t,enumerable:!0}):c,t)),x=t=\u003er(h({},\"__esModule\",{value:!0}),t);var a=y((T,l)=\u003e{l.exports=_jsx_runtime});var w={};k(w,{default:()=\u003ef,frontmatter:()=\u003ev});var e=b(a()),v={title:\"Tuning ElasticSearch storage\",authors:[\"khanh\"],date:\"2022-07-29\",tags:[\"engineering\",\"data\"],summary:\"Vi\\u1EC7c t\\u1ED1i \\u01B0u b\\u1ED9 nh\\u1EDB cho Database r\\u1EA5t quan tr\\u1ECDng \\u0111\\u1ED1i v\\u1EDBi 1 Data Engineer, sau \\u0111\\xE2y m\\xECnh s\\u1EBD chia s\\u1EBB nh\\u1EEFng c\\xE1ch m\\xE0 Fossil \\u0111\\xE3 s\\u1EED d\\u1EE5ng \\u0111\\u1EC3 t\\u1ED1i \\u01B0u b\\u1ED9 nh\\u1EDB cho ElasticSearch\",layout:\"PostLayout\"};function d(t){let n=Object.assign({p:\"p\",strong:\"strong\",pre:\"pre\",code:\"code\",a:\"a\",em:\"em\",h1:\"h1\"},t.components);return(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(n.p,{children:(0,e.jsx)(n.strong,{children:\"Fossil \\u0111\\xE3 \\u0111i\\u1EC1u ch\\u1EC9nh v\\xE0 t\\u1ED1i \\u01B0u b\\u1ED9 nh\\u1EDB cho c\\u1EE5m Elasticsearch nh\\u01B0 th\\u1EBF n\\xE0o?\"})}),`\n`,(0,e.jsx)(n.p,{children:\"B\\u1ED1i c\\u1EA3nh\"}),`\n`,(0,e.jsx)(n.p,{children:\"Fossil Vi\\u1EC7t Nam l\\xE0 m\\u1ED9t trung t\\xE2m nghi\\xEAn c\\u1EE9u n\\xEAn logs l\\xE0 m\\u1ED9t ph\\u1EA7n r\\u1EA5t quan tr\\u1ECDng. Ch\\xEDnh v\\xEC v\\u1EADy logs c\\u1EA7n \\u0111\\u01B0\\u1EE3c truy xu\\u1EA5t nhanh \\u0111\\u1EC3 \\u0111\\xE1p \\u1EE9ng nh\\u1EEFng nhu c\\u1EA7u nh\\u01B0 debug hardware, QA test c\\u0169ng nh\\u01B0 CS team c\\xF3 th\\u1EC3 ki\\u1EC3m tra log \\u0111\\u1EC3 gi\\xFAp \\u0111\\u1EE1 user trong l\\xFAc s\\u1EED d\\u1EE5ng app, ... Tr\\u01B0\\u1EDBc \\u0111\\xE2y, logs sau khi ETL th\\xEC \\u0111\\u01B0\\u1EE3c l\\u01B0u \\u1EDF S3 v\\xE0 sau \\u0111\\xF3 s\\u1EED d\\u1EE5ng Athena \\u0111\\u1EC3 truy xu\\u1EA5t, v\\u1EA5n \\u0111\\u1EC1 xu\\u1EA5t hi\\u1EC7n khi d\\xF9ng Athena truy xu\\u1EA5t c\\xE0ng nhi\\u1EC1u th\\xEC s\\u1EBD t\\u1ED1n chi ph\\xED query, c\\xF9ng v\\u1EDBi \\u0111\\xF3 v\\u1EDBi l\\u01B0\\u1EE3ng d\\u1EEF li\\u1EC7u l\\u1EDBn Athena th\\u01B0\\u1EDDng cho k\\u1EBFt qu\\u1EA3 kh\\xE1 l\\xE2u. V\\u1EDBi nh\\u1EEFng y\\xEAu c\\u1EA7u \\u0111\\xF3 m\\xECnh l\\u1EF1a ch\\u1ECDn Elasticsearch (ES) \\u0111\\u1EC3 l\\u01B0u tr\\u1EEF v\\xE0 tr\\xEDch xu\\u1EA5t log.\"}),`\n`,(0,e.jsx)(n.p,{children:\"ES kh\\xF4ng c\\xF2n qu\\xE1 xa l\\u1EA1 \\u0111\\u1EB7c bi\\u1EC7t l\\xE0 \\u0111\\u1ED1i v\\u1EDBi c\\xE1c Data Engineer trong b\\xE0i n\\xE0y m\\xECnh s\\u1EBD kh\\xF4ng n\\xF3i \\u0111\\u1EBFn vi\\u1EC7c ES l\\xE0m vi\\u1EC7c nh\\u01B0 th\\u1EBF n\\xE0o m\\xE0 m\\xECnh s\\u1EBD \\u0111\\u1EC1 c\\u1EADp \\u0111\\u1EBFn m\\u1ED9t v\\u1EA5n \\u0111\\u1EC1 khi c\\xE0i \\u0111\\u1EB7t ES tr\\xEAn k8s m\\xE0 m\\xECnh \\u0111\\xE3 g\\u1EB7p ph\\u1EA3i \\u0111\\xF3 l\\xE0 tunning storage cho es cluster. Ch\\xFAng ta \\u0111\\xE3 bi\\u1EBFt v\\xEC es s\\u1EBD index d\\u1EEF li\\u1EC7u c\\u1EE7a ch\\xFAng ta \\u0111\\u1EC3 t\\u0103ng t\\u1ED1c \\u0111\\u1ED9 truy xu\\u1EA5t cho n\\xEAn k\\xEDch th\\u01B0\\u1EDBc s\\u1EBD t\\u0103ng \\u0111\\xE1ng k\\u1EC3 so v\\u1EDBi d\\u1EEF li\\u1EC7u \\u0111\\u01B0\\u1EE3c l\\u01B0u \\u1EDF c\\xE1c storage kh\\xE1c nh\\u01B0 S3 hay GCS v\\xE0 k\\xEDch th\\u01B0\\u1EDBc \\u1EDF \\u0111\\xE2y l\\u1EA1i ch\\xEDnh l\\xE0 \\u0111\\u0129a \\u1EDF k8s cho n\\xEAn ch\\xFAng ta s\\u1EBD ph\\u1EA3i c\\xE2n \\u0111\\u1ED1i c\\xE1c config \\u0111\\u1EC3 v\\u1EEBa \\u0111\\xE1p \\u1EE9ng v\\u1EDBi nhu c\\u1EA7u v\\xE0 t\\u1ED1c \\u0111\\u1ED9 truy xu\\u1EA5t d\\u1EEF li\\u1EC7u. V\\u1EDBi Fossil, d\\u1EEF li\\u1EC7u \\u1EDF d\\u1EA1ng json, nhu c\\u1EA7u search ch\\xEDnh x\\xE1c gi\\xE1 tr\\u1ECB \\u0111\\u1ED1i v\\u1EDBi m\\u1ED9t s\\u1ED1 fields v\\xED d\\u1EE5 nh\\u01B0 (userid, testid, ...).\"}),`\n`,(0,e.jsx)(n.p,{children:\"Khi kh\\xF4ng s\\u1EED d\\u1EE5ng template\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-bash\",children:`GET localhost:9200/_cat/indices?v=true\u0026s=index\n\nindex                       pri rep docs.count store.size pri.store.size\nsdk_log-2022-03-14            1   1     324105    202.2mb        202.2mb\n`})}),`\n`,(0,e.jsx)(n.p,{children:\"V\\xE0 d\\u01B0\\u1EDBi \\u0111\\xE2y l\\xE0 d\\u1EABn ch\\u1EE9ng cho ta th\\u1EA5y t\\u1EA7m quan tr\\u1ECDng c\\u1EE7a ES template\"}),`\n`,(0,e.jsxs)(n.p,{children:[\"\\u0110\\u1EA7u ti\\xEAn ch\\xFAng ta thay \\u0111\\u1ED5i \",(0,e.jsx)(n.strong,{children:\"compression type.\"}),\" M\\u1EB7c \\u0111\\u1ECBnh ES l\\xE0 LZ4 s\\u1EBD \\u0111\\u01B0\\u1EE3c \\xE1p d\\u1EE5ng, ch\\xFAng ta c\\xF3 th\\u1EC3 \\xE1p d\\u1EE5ng \",(0,e.jsx)(n.code,{children:\"best_compression\"}),\" s\\u1EED d\\u1EE5ng DEFLATE gi\\xFAp t\\u1EC9 l\\u1EC7 n\\xE9n cao h\\u01A1n nh\\u01B0ng s\\u1EBD d\\u1EABn t\\u1EDBi vi\\u1EC7c th\\u1EDDi gian n\\xE9n l\\xE2u h\\u01A1n. Tuy nhi\\xEAn \\u0111i\\u1EC1u n\\xE0y c\\xF3 th\\u1EC3 ch\\u1EA5p nh\\u1EADn \\u0111\\u01B0\\u1EE3c trong b\\u1ED1i c\\u1EA3nh ch\\xFAng ta \\u0111ang c\\u1EA7n \\u01B0u ti\\xEAn t\\u1ED1i \\u01B0u b\\u1ED9 nh\\u1EDB ...\"]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-bash\",children:`PUT localhost:9200/_template/sdk_log\n\n{\n    \"index_patterns\": [\n        \"sdk_log-*\"\n    ],\n    \"settings\": {\n        \"codec\": \"best_compression\",\n        \"merge.policy.max_merged_segment\": \"5mb\"\n    }\n}\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[\"~13% b\\u1ED9 nh\\u1EDB \\u0111\\u01B0\\u1EE3c thu nh\\u1ECF khi d\\xF9ng \",(0,e.jsx)(n.code,{children:\"best_compression\"})]}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-bash\",children:`GET localhost:9200/_cat/indices?v=true\u0026s=index\n\nindex                                pri rep docs.count store.size pri.store.size\nsdk_log_best_compression-2022-03-14    1   1     324105    175.4mb        175.4mb\n\n`})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Ti\\u1EBFp theo ta c\\u1EA7n \\u0111i s\\xE2u m\\u1ED9t ch\\xFAt t\\xECm hi\\u1EC3u kh\\xE1i ni\\u1EC7m \",(0,e.jsx)(n.strong,{children:\"Mapping\"}),\". Mapping l\\xE0 m\\u1ED9t quy tr\\xECnh \\u0111\\u1EC3 \\u0111\\u1ECBnh ngh\\u0129a m\\u1ED9t b\\u1EA3n ghi v\\xE0 c\\xE1ch m\\xE0 c\\xE1c fields s\\u1EBD \\u0111\\u01B0\\u1EE3c qu\\u1EA3n l\\xFD, l\\u01B0u tr\\u1EEF v\\xE0 l\\u1EADp ch\\u1EC9 m\\u1EE5c. V\\xEC v\\u1EADy v\\u1EDBi m\\u1ED7i mapping kh\\xE1c nhau s\\u1EBD d\\u1EABn \\u0111\\u1EBFn kh\\xF4ng gian l\\u01B0u tr\\u1EEF v\\xE0 hi\\u1EC7u su\\u1EA5t kh\\xE1c nhau.\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Sau \\u0111\\xE2y l\\xE0 3 tham s\\u1ED1 m\\xECnh \\u0111\\xE3 d\\xF9ng \\u0111\\u1EC3 t\\u1ED1i \\u01B0u b\\u1ED9 nh\\u1EDB.\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.strong,{children:\"Field data types\"})}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.a,{href:\"https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html#mapping-types\",children:\"https://www.elastic.co/guide/en/elasticsearch/reference/current/mapping-types.html#mapping-types\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"M\\u1ED7i field s\\u1EBD c\\xF3 m\\u1ED9t \",(0,e.jsx)(n.em,{children:\"field data type\"}),\" n\\xF3 ch\\u1EC9 ra lo\\u1EA1i d\\u1EEF li\\u1EC7u c\\u1EE7a field \\u0111\\xF3. Ki\\u1EC3u d\\u1EEF li\\u1EC7u ch\\xFAng ta d\\xF9ng nhi\\u1EC1u nh\\u1EA5t v\\u1EDBi ES l\\xE0 ki\\u1EC3u chu\\u1ED7i (string) n\\xEAn ch\\xFAng ta c\\u1EA7n hi\\u1EC3u r\\xF5 hai lo\\u1EA1i \",(0,e.jsx)(n.strong,{children:\"text\"}),\" v\\xE0 \",(0,e.jsx)(n.strong,{children:\"keyword\"}),\". V\\u1EDBi text field d\\u1EEF li\\u1EC7u s\\u1EBD \\u0111\\u01B0\\u1EE3c ph\\xE2n t\\xEDch \\u0111\\u1EC3 \\u0111\\xE1p \\u1EE9ng nhu c\\u1EA7u full-text search trong khi v\\u1EDBi keyword d\\u1EEF li\\u1EC7u \\u0111\\u01B0\\u1EE3c gi\\u1EEF nguy\\xEAn \\u0111\\u1EC3 \\u0111\\xE1p \\u1EE9ng vi\\u1EC7c s\\u1EAFp x\\u1EBFp v\\xE0 l\\u1ECDc d\\u1EEF li\\u1EC7u. V\\u1EADy n\\xEAn t\\xF9y v\\xE0o nhu c\\u1EA7u truy xu\\u1EA5t b\\u1EA1n h\\xE3y ch\\u1ECDn ki\\u1EC3u d\\u1EEF li\\u1EC7u cho c\\xE1c field m\\u1ED9t c\\xE1ch h\\u1EE3p l\\xFD, theo m\\xECnh h\\u1EA1n ch\\u1EBF d\\xF9ng text file nh\\u1EEFng field cho nhu c\\u1EA7u t\\xECm ki\\u1EBFm g\\u1EA7n \\u0111\\xFAng nh\\u01B0 title, content, \\u2026 ta n\\xEAn d\\xF9ng text field, c\\xF2n l\\u1EA1i nh\\u1EEFng field y\\xEAu c\\u1EA7u t\\xECm ki\\u1EBFm ch\\xEDnh x\\xE1c match 100% ch\\xFAng ta s\\u1EBD d\\xF9ng keyword.\"]}),`\n`,(0,e.jsxs)(n.p,{children:[\"C\\xE1c field types \\u0111\\u01B0\\u1EE3c nh\\xF3m l\\u1EA1i theo \",(0,e.jsx)(n.em,{children:\"family\"}),\". C\\xE1c lo\\u1EA1i d\\u1EEF li\\u1EC7u c\\xF9ng \",(0,e.jsx)(n.em,{children:\"family\"}),\" s\\u1EBD c\\xF3 ph\\u01B0\\u01A1ng th\\u1EE9c truy xu\\u1EA5t ho\\xE0n to\\xE0n gi\\u1ED1ng nhau nh\\u01B0ng s\\u1EBD c\\xF3 s\\u1EF1 kh\\xE1c nhau v\\u1EC1 kh\\xF4ng gian l\\u01B0u tr\\u1EEF v\\xE0 hi\\u1EC7u su\\u1EA5t.\"]}),`\n`,(0,e.jsx)(n.p,{children:\"V\\xED d\\u1EE5 ch\\xFAng ta config ki\\u1EC3u d\\u1EEF li\\u1EC7u cho tr\\u01B0\\u1EDDng d\\u1EEF li\\u1EC7u brand.\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-bash\",children:`PUT localhost:9200/_template/sdk_log\n\n{\n    \"index_patterns\": [\n        \"sdk_log-*\"\n    ],\n    \"settings\": {\n        \"codec\": \"best_compression\",\n        \"merge.policy.max_merged_segment\": \"5mb\"\n    },\n    \"mappings\": {\n        \"properties\": {\n            },\n            \"brand\": {\n                \"type\": \"text\"\n            },\n        }\n    }\n}\n`})}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.strong,{children:\"doc_values\"})}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.a,{href:\"https://www.elastic.co/guide/en/elasticsearch/reference/8.1/doc-values.html\",children:\"https://www.elastic.co/guide/en/elasticsearch/reference/8.1/doc-values.html\"})}),`\n`,(0,e.jsxs)(n.p,{children:[\"Doc values l\\xE0 m\\u1ED9t ki\\u1EC3u d\\u1EEF li\\u1EC7u tr\\xEAn \\u0111\\u0129a (the on-disk data structure). Ph\\u1EA7n l\\u1EDBn c\\xE1c fields s\\u1EBD \\u0111\\u01B0\\u1EE3c m\\u1EB7c \\u0111\\u1ECBnh l\\u1EADp ch\\u1EC9 m\\u1EE5c (indexed) gi\\xFAp ch\\xFAng c\\xF3 th\\u1EC3 t\\xECm ki\\u1EBFm (searchable). \",(0,e.jsx)(n.a,{href:\"https://www.elastic.co/guide/en/elasticsearch/reference/8.1/number.html\",children:\"Numeric types\"}),\", \",(0,e.jsx)(n.a,{href:\"https://www.elastic.co/guide/en/elasticsearch/reference/8.1/date.html\",children:\"date types\"}),\", \",(0,e.jsx)(n.a,{href:\"https://www.elastic.co/guide/en/elasticsearch/reference/8.1/boolean.html\",children:\"boolean type\"}),\", \",(0,e.jsx)(n.a,{href:\"https://www.elastic.co/guide/en/elasticsearch/reference/8.1/ip.html\",children:\"ip type\"}),\", \",(0,e.jsx)(n.a,{href:\"https://www.elastic.co/guide/en/elasticsearch/reference/8.1/geo-point.html\",children:\"geo_point type\"}),\" v\\xE0 \",(0,e.jsx)(n.a,{href:\"https://www.elastic.co/guide/en/elasticsearch/reference/8.1/keyword.html\",children:\"keyword type\"}),\" v\\u1EABn c\\xF3 th\\u1EC3 truy xu\\u1EA5t khi ch\\xFAng kh\\xF4ng \\u0111\\u01B0\\u1EE3c \",(0,e.jsx)(n.a,{href:\"https://www.elastic.co/guide/en/elasticsearch/reference/8.1/mapping-index.html\",children:\"indexed\"}),\" m\\xE0 ch\\u1EC9 c\\xF3 doc values \\u0111\\u01B0\\u1EE3c b\\u1EADt \\u0111\\xF3 l\\xE0 kh\\xE1i ni\\u1EC7m \",(0,e.jsx)(n.strong,{children:\"doc-value-only fileds\"}),\". Hi\\u1EC7u su\\u1EA5t truy xu\\u1EA5t s\\u1EBD ch\\u1EADm h\\u01A1n nh\\u01B0ng ch\\xFAng ta c\\xF3 th\\u1EC3 \\u0111\\xE1nh \\u0111\\u1ED5i v\\u1EDBi kh\\xF4ng gian l\\u01B0u tr\\u1EEF tr\\xEAn \\u0111\\u0129a trong c\\xE1c tr\\u01B0\\u1EDDng h\\u1EE3p field \\u0111\\xF3 \\xEDt khi \\u0111\\u01B0\\u1EE3c truy su\\u1EA5t ho\\u1EB7c t\\u1ED1c \\u0111\\u1ED9 truy xu\\u1EA5t kh\\xF4ng quan tr\\u1ECDng. \\u1EDE Fossil, ngay c\\u1EA3 khi t\\u1ED1c \\u0111\\u1ED9 truy xu\\u1EA5t b\\u1ECB \\u0111\\xE1nh \\u0111\\u1ED5i c\\u01A1 b\\u1EA3n n\\xF3 v\\u1EABn nhanh h\\u01A1n r\\u1EA5t nhi\\u1EC1u so v\\u1EDBi Athena.\"]}),`\n`,(0,e.jsx)(n.p,{children:\"Doc-value-only field c\\xF3 th\\u1EC3 config nh\\u01B0 sau:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-bash\",children:`PUT localhost:9200/\\\\_template/sdk_log\n{\n    \"index_patterns\": [\n        \"sdk_log-*\"\n    ],\n    \"settings\": {\n        \"codec\": \"best_compression\",\n        \"merge.policy.max_merged_segment\": \"5mb\"\n    },\n    \"mappings\": {\n        \"properties\": {},\n        \"brand\": {\n            \"type\": \"text\",\n            \"index\": \"false\"\n        },\n    }\n}\n`})}),`\n`,(0,e.jsx)(n.p,{children:\"Th\\u1EADm ch\\xED n\\u1EBFu b\\u1EA1n kh\\xF4ng c\\u1EA7n t\\u1ED5ng h\\u1EE3p, s\\u1EAFp x\\u1EBFp hay thay \\u0111\\u1ED5i gi\\xE1 tr\\u1ECB c\\u1EE7a m\\u1ED9t tr\\u01B0\\u1EDDng d\\u1EEF li\\u1EC7u ch\\xFAng ta c\\xF3 ho\\xE0n to\\xE0n c\\xF3 th\\u1EC3 t\\u1EAFt doc values \\u0111\\u1EC3 t\\u1ED1i \\u01B0u b\\u1ED9 nh\\u1EDB.\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-bash\",children:`PUT localhost:9200/\\\\_template/sdk_log\n{\n    \"index_patterns\": [\n        \"sdk_log-*\"\n    ],\n    \"settings\": {\n        \"codec\": \"best_compression\",\n        \"merge.policy.max_merged_segment\": \"5mb\"\n    },\n    \"mappings\": {\n        \"properties\": {},\n        \"brand\": {\n            \"type\": \"text\",\n            \"index\": \"false\",\n            \"doc_values\": \"false\"\n        },\n    }\n}\n`})}),`\n`,(0,e.jsx)(n.p,{children:\"V\\xE0 ch\\xFAng ta xem b\\u1ED9 nh\\u1EDB \\u0111\\xE3 gi\\u1EA3m nh\\u01B0 th\\u1EBF n\\xE0o:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-bash\",children:`GET localhost:9200/_cat/indices?v=true\u0026s=index\n\nindex                                pri rep docs.count store.size pri.store.size\nsdk_log-disable_doc_values-2022-03-14  1   1     324105     82.9mb         82.9mb\n`})}),`\n`,(0,e.jsx)(n.p,{children:\"~60% dung l\\u01B0\\u1EE3ng b\\u1ED9 nh\\u1EDB \\u0111\\u01B0\\u1EE3c t\\u1ED1i \\u01B0u\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.strong,{children:\"norms\"})}),`\n`,(0,e.jsx)(n.p,{children:\"Norms l\\u01B0u tr\\u1EEF c\\xE1c y\\u1EBFu t\\u1ED1 chu\\u1EA9n h\\xF3a kh\\xE1c nhau gi\\xFAp \\xEDch cho vi\\u1EC7c t\\u1EA1i th\\u1EDDi \\u0111i\\u1EC3m truy v\\u1EA5n c\\xF3 th\\u1EC3 t\\xEDnh \\u0111i\\u1EC3m d\\u1EEF li\\u1EC7u khi truy v\\u1EA5n. M\\u1EB7c d\\xF9 h\\u1EEFu \\xEDch cho vi\\u1EC7c t\\xEDnh \\u0111i\\u1EC3m, \\u0111\\xE1p \\u1EE9ng nhu c\\u1EA7u cho vi\\u1EC7c t\\xECm ki\\u1EBFm g\\u1EA7n \\u0111\\xFAng nh\\u01B0ng norms c\\u1EA7n kh\\xE1 nhi\\u1EC1u kh\\xF4ng gian tr\\xEAn \\u0111\\u0129a. V\\xEC v\\u1EADy \\u0111\\u1ED1i v\\u1EDBi nh\\u1EEFng tr\\u01B0\\u1EDDng kh\\xF4ng c\\xF3 nhu c\\u1EA7u tr\\xEAn ch\\xFAng ta c\\xF3 th\\u1EC3 t\\u1EAFt norms nh\\u01B0 sau:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-bash\",children:`PUT localhost:9200/\\\\_template/sdk_log\n{\n    \"index_patterns\": [\n        \"sdk_log-*\"\n    ],\n    \"settings\": {\n        \"codec\": \"best_compression\",\n        \"merge.policy.max_merged_segment\": \"5mb\"\n    },\n    \"mappings\": {\n        \"properties\": {},\n        \"brand\": {\n            \"type\": \"text\",\n            \"index\": \"false\",\n            \"doc_values\": \"false\"\n            \"norms\": \"false\"\n        },\n    }\n}\n`})}),`\n`,(0,e.jsx)(n.p,{children:\"Th\\xEAm kho\\u1EA3ng ~1% b\\u1ED9 nh\\u1EDB \\u0111\\u01B0\\u1EE3c t\\u1ED1i \\u01B0u:\"}),`\n`,(0,e.jsx)(n.pre,{children:(0,e.jsx)(n.code,{className:\"language-bash\",children:`GET localhost:9200/_cat/indices?v=true\u0026s=index\n\nindex                                pri rep docs.count store.size pri.store.size\nsdk_log-disable_doc_values-2022-03-14  1   1     324105       80mb         80mb\n`})}),`\n`,(0,e.jsx)(n.h1,{children:\"References\"}),`\n`,(0,e.jsx)(n.p,{children:(0,e.jsx)(n.a,{href:\"https://www.elastic.co/guide/index.html\",children:\"https://www.elastic.co/guide/index.html\"})})]})}function _(t={}){let{wrapper:n}=t.components||{};return n?(0,e.jsx)(n,Object.assign({},t,{children:(0,e.jsx)(d,t)})):d(t)}var f=_;return x(w);})();\n;return Component;","toc":[],"frontMatter":{"readingTime":{"text":"6 min read","minutes":5.99,"time":359400,"words":1198},"slug":"tuning-es-storage","fileName":"2022-07-29-tuning-es-storage.md","title":"Tuning ElasticSearch storage","authors":["khanh"],"date":"2022-07-29T00:00:00.000Z","tags":["engineering","data"],"summary":"Việc tối ưu bộ nhớ cho Database rất quan trọng đối với 1 Data Engineer, sau đây mình sẽ chia sẻ những cách mà Fossil đã sử dụng để tối ưu bộ nhớ cho ElasticSearch","layout":"PostLayout"}},"authorDetails":[{"readingTime":{"text":"1 min read","minutes":0.18,"time":10800,"words":36},"slug":["khanh"],"fileName":"khanh.md","name":"Vu Duy Khanh","avatar":"https://avatars.githubusercontent.com/u/32119373?v=4","occupation":"Data Engineer","company":"Fossil Vietnam","email":"vdkhanh@fossil.com","linkedin":"https://www.linkedin.com/in/kh%C3%A1nh-v%C5%A9-duy-a1a3b1135/","github":"https://github.com/DuyKhanhVu","date":null}],"prev":{"title":"Apache Spark behind the scenes","authors":["hung"],"date":"2022-07-12T00:00:00.000Z","tags":["engineering","data"],"summary":"Các bạn có thắc mắc sau khi submit 1 job cho Spark Cluster thì Spark sẽ làm những gì không? Cùng tìm hiểu với mình nhé.","layout":"PostLayout","slug":"apache-spark-behind-the-scienes"},"next":null},"__N_SSG":true},"page":"/blog/[...slug]","query":{"slug":["tuning-es-storage"]},"buildId":"YdCaCMbXHg7ZfyRqMsMQm","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>